pipeline {
    agent any
    tools {
        nodejs 'NodeJS-24.0.2'
    }
    environment {
        CI = 'true'
        DOCKER_REGISTRY = "namgyelhuk708"
        APP_NAME = "practical-node-app"
        DOCKER_CREDENTIALS_ID = "docker-credentials"
    }
    
    stages {
        stage('Checkout') { steps { checkout scm } }
        stage('Install') { steps { sh 'npm install' } }
        stage('Test') { 
            steps { sh 'npm run test:ci' }
            post { always { junit 'junit.xml' } }
        }
        stage('Build') { steps { sh 'npm run build' } }
        
        // Docker stages MUST be before Deploy
        stage('Docker Build') {
            steps {
                script {
                    dockerImage = docker.build("${DOCKER_REGISTRY}/${APP_NAME}:${BUILD_NUMBER}")
                }
            }
        }
        stage('Docker Push') {
            steps {
                script {
                    docker.withRegistry('', DOCKER_CREDENTIALS_ID) {
                        dockerImage.push()
                        if (env.BRANCH_NAME == 'main') {
                            dockerImage.push('latest')
                        }
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'main') {
                        sh 'echo "Production deployment"'
                    } else {
                        sh 'echo "Staging deployment"'
                    }
                }
            }
        }
    }
}