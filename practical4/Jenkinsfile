pipeline {
    agent any
    tools {
        nodejs 'NodeJS-24.0.2' // Must match your Jenkins config
    }
    environment {
        CI = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps { checkout scm }
        }
        
        stage('Install') {
            steps { sh 'npm install' }
        }
        
        stage('Test') {
            steps { sh 'npm run test:ci' }
            post {
                always {
                    junit 'junit.xml'
                    archiveArtifacts artifacts: 'coverage/**/*'
                }
            }
        }
        
        stage('Build') {
            steps { sh 'npm run build' }
        }
        
        // ===== ADD THESE NEW STAGES =====
        stage('Docker Build') {
            steps {
                script {
                    dockerImage = docker.build("namgyelhuk708/practical-node-app:${BUILD_NUMBER}")
                }
            }
        }
        
        stage('Docker Push') {
            steps {
                script {
                    docker.withRegistry('', 'docker-credentials') {
                        dockerImage.push()
                        if (env.BRANCH_NAME == 'main') {
                            dockerImage.push('latest')
                        }
                    }
                }
            }
        }
        // ================================
        
        stage('Deploy') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'main') {
                        sh 'echo "Production deployment"'
                    } else {
                        sh 'echo "Staging deployment"'
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh 'docker system prune -f'
            cleanWs()
        }
    }
}